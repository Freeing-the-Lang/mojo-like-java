name: "Mojo-like-Java â€” 3OS AutoBuild + ProofLedger + Auto Release"

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: mojo-like-java-release-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-3os:
    name: "Build â€” ${{ matrix.os }}"
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "21"

      - name: Create dist folder
        run: mkdir -p dist

      - name: Build Mojo-like-Java
        shell: bash
        run: |
          OS_TAG="${{ matrix.os }}"

          # íŒŒì¼ ì´ë¦„
          ENTRY_JAVA="Entry-${OS_TAG}.java"
          ENTRY_CLASS="Entry-${OS_TAG}.class"
          BUILD_INFO="build-info-${OS_TAG}.txt"

          # public class ì œê±° (Java íŒŒì¼ëª… ê·œì¹™ ìš°íšŒ)
          echo "class Entry { public static void main(String[] args) { System.out.println(\"Mojo-like-Java Running on ${OS_TAG}!\"); } }" > ${ENTRY_JAVA}

          # ì»´íŒŒì¼
          javac ${ENTRY_JAVA}

          mv Entry.class ${ENTRY_CLASS} || true

          mv ${ENTRY_JAVA} dist/
          mv ${ENTRY_CLASS} dist/

          echo "Build on ${OS_TAG}" > dist/${BUILD_INFO}

          # OSë³„ ì¶œë ¥ íŒŒì¼
          echo "${OS_TAG} build" > dist/out-${OS_TAG}.txt

      - name: Generate ProofLedger
        shell: bash
        run: |
          OS_TAG="${{ matrix.os }}"
          LEDGER="proofledger-${OS_TAG}.txt"

          echo "Repository: ${{ github.repository }}" > ${LEDGER}
          echo "Commit: ${{ github.sha }}" >> ${LEDGER}
          echo "OS: ${OS_TAG}" >> ${LEDGER}
          echo "Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> ${LEDGER}
          echo "Branch: ${{ github.ref }}" >> ${LEDGER}
          echo "--------------------------------------" >> ${LEDGER}

          sha_file=$(ls dist/out-${OS_TAG}.txt)

          if [[ "${OS_TAG}" == "windows-latest" ]]; then
            certutil -hashfile "${sha_file}" SHA256 >> ${LEDGER}
          elif [[ "${OS_TAG}" == "macos-latest" ]]; then
            shasum -a 256 "${sha_file}" >> ${LEDGER}
          else
            sha256sum "${sha_file}" >> ${LEDGER}
          fi

          mv ${LEDGER} dist/

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mojo-like-java-${{ matrix.os }}-${{ github.run_id }}
          path: dist/

  release:
    name: "Publish Release"
    runs-on: ubuntu-latest
    needs: [build-3os]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-bundle

      - name: Generate version tag
        id: tagger
        run: echo "tag=v1.0.${{ github.run_id }}" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tagger.outputs.tag }}
          name: "Mojo-like-Java Auto Release ${{ steps.tagger.outputs.tag }}"
          body: |
            ## ðŸš€ Mojo-like-Java Auto Release
            - 3OS Build Completed  
            - ProofLedger Included  
            - SHA256 Verified  
            - Commit: ${{ github.sha }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Assets to Release
        uses: shogo82148/actions-upload-release-asset@v1
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: release-bundle/**
          overwrite: false
