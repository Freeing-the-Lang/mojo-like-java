name: "Mojo-like-Java â€” 3OS AutoBuild + ProofLedger + Auto Release"

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: mojo-like-java-release-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-3os:
    name: "Build â€” ${{ matrix.os }}"
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      # ----------------------------------------------------------
      # Checkout
      # ----------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ----------------------------------------------------------
      # Java
      # ----------------------------------------------------------
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "21"

      # ----------------------------------------------------------
      # Build
      # ----------------------------------------------------------
      - name: Create dist folder
        run: mkdir -p dist

      - name: Build Mojo-like-Java
        shell: bash
        run: |
          OS_TAG="${{ matrix.os }}"

          ENTRY_JAVA="Entry-${OS_TAG}.java"
          ENTRY_CLASS="Entry-${OS_TAG}.class"
          BUILD_INFO="build-info-${OS_TAG}.txt"

          echo "class Entry { public static void main(String[] args) { System.out.println(\"Mojo-like-Java Running on ${OS_TAG}!\"); } }" > ${ENTRY_JAVA}

          javac ${ENTRY_JAVA}

          mv Entry.class ${ENTRY_CLASS}

          mv ${ENTRY_JAVA} dist/
          mv ${ENTRY_CLASS} dist/

          echo "Build on ${OS_TAG}" > dist/${BUILD_INFO}

          echo "${OS_TAG} build" > dist/out-${OS_TAG}.txt

      # ----------------------------------------------------------
      # ProofLedger (SHA256)
      # ----------------------------------------------------------
      - name: Generate ProofLedger
        shell: bash
        run: |
          OS_TAG="${{ matrix.os }}"
          LEDGER="proofledger-${OS_TAG}.txt"

          echo "Repository: ${{ github.repository }}" > ${LEDGER}
          echo "Commit: ${{ github.sha }}" >> ${LEDGER}
          echo "OS: ${OS_TAG}" >> ${LEDGER}
          echo "Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> ${LEDGER}
          echo "Branch: ${{ github.ref }}" >> ${LEDGER}
          echo "--------------------------------------" >> ${LEDGER}

          sha_file="dist/out-${OS_TAG}.txt"

          if [[ "${OS_TAG}" == "windows-latest" ]]; then
            certutil -hashfile "${sha_file}" SHA256 >> ${LEDGER}
          elif [[ "${OS_TAG}" == "macos-latest" ]]; then
            shasum -a 256 "${sha_file}" >> ${LEDGER}
          else
            sha256sum "${sha_file}" >> ${LEDGER}
          fi

          mv ${LEDGER} dist/

      # ----------------------------------------------------------
      # Upload to Actions
      # ----------------------------------------------------------
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mojo-like-java-${{ matrix.os }}-${{ github.run_id }}
          path: dist/

  # ============================================================
  # Release job
  # ============================================================
  release:
    name: "Publish Release"
    runs-on: ubuntu-latest
    needs: [build-3os]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ----------------------------------------------------------
      # Download all artifacts
      # ----------------------------------------------------------
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-bundle

      # ----------------------------------------------------------
      # ZIP each OS bundle (ì¤‘ë³µ/í´ë” ë¬¸ì œ ì™„ì „ í•´ê²°)
      # ----------------------------------------------------------
      - name: Zip artifacts
        run: |
          cd release-bundle
          for d in */ ; do
            zip -r "${d%/}.zip" "$d"
          done

      # ----------------------------------------------------------
      # Version Tag
      # ----------------------------------------------------------
      - name: Generate version tag
        id: tagger
        run: echo "tag=v1.0.${{ github.run_id }}" >> $GITHUB_OUTPUT

      # ----------------------------------------------------------
      # Create GitHub Release
      # ----------------------------------------------------------
      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tagger.outputs.tag }}
          name: "Mojo-like-Java Auto Release ${{ steps.tagger.outputs.tag }}"
          body: |
            ## ðŸš€ Mojo-like-Java Auto Release
            - 3 OS Build Complete
            - ProofLedger Included (SHA256)
            - Commit: ${{ github.sha }}
            - Run ID: ${{ github.run_id }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ----------------------------------------------------------
      # Upload ZIP assets
      # ----------------------------------------------------------
      - name: Upload zipped assets to Release
        uses: shogo82148/actions-upload-release-asset@v1
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: release-bundle/*.zip
          overwrite: false
